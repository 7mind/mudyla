name: CI/CD

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v14

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Check flake
      run: nix flake check

    - name: Build package
      run: nix build

    - name: Run test suite
      run: bash run-tests.sh

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: test-reports/junit.xml
        check_name: Test Results
        comment_mode: off

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-reports/
        retention-days: 7

    - name: Test GitHub Actions integration
      run: nix run . -- --github-actions :create-directory :write-message

    - name: Build and test wheel
      run: |
        pip install build
        python -m build --wheel
        python -m venv /tmp/test-venv
        /tmp/test-venv/bin/pip install dist/mudyla-*.whl
        /tmp/test-venv/bin/mdl --help
        /tmp/test-venv/bin/python -c "from mudyla.cli import main; print('OK')"

    - name: Archive run directories
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mudyla-runs
        path: .mdl/runs/
        retention-days: 1

  type-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v14

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Run mypy type checking
      run: nix develop --command bash -c "mypy mudyla --check-untyped-defs || true"

  test-macos:
    runs-on: macos-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v14

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Check flake
      run: nix flake check

    - name: Build package
      run: nix build

    - name: Run test suite
      run: bash run-tests.sh

    - name: Archive run directories
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mudyla-runs-macos
        path: .mdl/runs/
        retention-days: 1

  test-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install UV
      run: pip install uv

    - name: Install package
      run: uv pip install --system -e .

    - name: Test auto-detection of Windows (should enable --without-nix)
      shell: bash
      run: python -m mudyla :create-directory :write-message

    - name: Test explicit --without-nix flag
      shell: bash
      run: python -m mudyla --without-nix :create-directory :write-message

    - name: Verify outputs
      shell: bash
      run: |
        if [ ! -d "test-output" ]; then
          echo "ERROR: test-output directory not created"
          exit 1
        fi
        if [ ! -f "test-output/message.txt" ]; then
          echo "ERROR: message.txt not created"
          exit 1
        fi
        echo "SUCCESS: Windows tests passed"

    - name: Archive run directories
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mudyla-runs-windows
        path: .mdl/runs/
        retention-days: 1

  build-dist:
    name: Build distribution
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # Only run on version tags

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build distribution
      run: python -m build

    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

  publish-to-pypi:
    name: Publish to PyPI
    needs: [test, type-check, test-macos, test-windows, build-dist]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # Only run on version tags

    environment:
      name: pypi
      url: https://pypi.org/p/mudyla

    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

  github-release:
    name: Create GitHub Release
    needs: publish-to-pypi
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # Only run on version tags

    permissions:
      contents: write  # IMPORTANT: mandatory for making GitHub Releases

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        gh release create \
          '${{ github.ref_name }}' \
          --repo '${{ github.repository }}' \
          --notes "Release ${{ github.ref_name }}"

    - name: Upload artifact signatures to GitHub Release
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        gh release upload \
          '${{ github.ref_name }}' dist/** \
          --repo '${{ github.repository }}'
