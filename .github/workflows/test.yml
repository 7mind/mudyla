name: Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v14

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Check flake
      run: nix flake check

    - name: Build package
      run: nix build

    - name: Run test suite
      run: bash test.sh

    - name: Test GitHub Actions integration
      run: nix run . -- --github-actions :create-directory :write-message

    - name: Archive run directories
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mudyla-runs
        path: .mdl/runs/
        retention-days: 1

  type-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v14

    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Run mypy type checking
      run: nix develop --command bash -c "mypy mudyla --check-untyped-defs || true"

  test-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install UV
      run: pip install uv

    - name: Install package
      run: uv pip install --system -e .

    - name: Test auto-detection of Windows (should enable --without-nix)
      shell: bash
      run: python -m mudyla :create-directory :write-message

    - name: Test explicit --without-nix flag
      shell: bash
      run: python -m mudyla --without-nix :create-directory :write-message

    - name: Verify outputs
      shell: bash
      run: |
        if [ ! -d "test-output" ]; then
          echo "ERROR: test-output directory not created"
          exit 1
        fi
        if [ ! -f "test-output/message.txt" ]; then
          echo "ERROR: message.txt not created"
          exit 1
        fi
        echo "SUCCESS: Windows tests passed"

    - name: Archive run directories
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: mudyla-runs-windows
        path: .mdl/runs/
        retention-days: 1
